---
- semaphore:
    name: sf-operator-publish-semaphore
    max: 1

# Base CI job
- job:
    name: sf-operator
    parent: sf-operator-microshift
    timeout: 3600
    pre-run:
      - playbooks/health-check/dstat-pre.yaml
    post-run:
      - playbooks/health-check/dstat-post.yaml
      - playbooks/post.yaml
    run: playbooks/main.yaml
    abstract: true
    irrelevant-files:
      - ".*.md$"
      - "doc/.*"
      - ".github/.*"
    required-projects:
      - name: software-factory/sf-infra
    roles:
      - zuul: software-factory/sf-infra
    vars:
      logreduce_optin: true
      # microshift deployment
      disk_file_sparsed: true
      disk_file_size: 40G
      standard_user: false
      create_pv: false
      setup_olm: true
      # post tasks artifacts directory
      output_logs_dir: ~/zuul-output/logs
      # dnsmasq
      microshift_additional_addresses:
        - "sfop.me"
      etcd_on_ramdisk: true
      cloudprovider_dns:
        - 199.204.44.24
        - 199.204.47.54

- job:
    name: sf-operator-multinode
    parent: sf-operator-microshift-multinode
    timeout: 3600
    pre-run:
      - playbooks/health-check/dstat-pre.yaml
    post-run:
      - playbooks/health-check/dstat-post.yaml
      - playbooks/post.yaml
    run: playbooks/main.yaml
    abstract: true
    irrelevant-files:
      - ".*.md$"
      - "doc/.*"
      - ".github/.*"
    required-projects:
      - name: software-factory/sf-infra
    roles:
      - zuul: software-factory/sf-infra
    vars:
      logreduce_optin: true
      # microshift deployment
      disk_file_sparsed: true
      disk_file_size: 40G
      standard_user: false
      create_pv: false
      setup_olm: true
      # post tasks artifacts directory
      output_logs_dir: ~/zuul-output/logs
      # dnsmasq
      microshift_additional_addresses:
        - "sfop.me"

# Images publication job
- job:
    name: sf-operator-publish-olm-bundle-image
    description: Publish operator's olm bundle image
    semaphore: sf-operator-publish-semaphore
    run: playbooks/publish.yaml
    timeout: 1200
    nodeset:
      nodes:
        name: controller
        label: cloud-centos-9-stream
    secrets:
      - name: final_registry_secret
        secret: zuul_quay_sf

# Deploy sf-operator on microshift
- job:
    name: sf-operator-olm
    description: This test validates a sf-operator deployment via OLM
    parent: sf-operator
    vars:
      mode: "olm"

- job:
    name: sf-operator-upgrade
    parent: sf-operator
    run: playbooks/upgrade.yaml
    timeout: 3600

- job:
    name: sf-operator-dev-multinode
    description: >
      This test validates a sf-operator multinode deployment
      via the dev mode described in the contributor doc
    parent: sf-operator-multinode
    vars:
      mode: "dev"

- job:
    name: sf-operator-ansible-lint
    parent: ansible-lint
    vars:
      # NOTE(dpawlik): We don't need to add roles dir, due there is a symlink
      # done in playbooks that is related to roles dir.
      ansible_lint_playbooks_dir: playbooks
      ansible_lint_check_all: false
    nodeset:
      nodes:
        - name: controller
          label: cloud-centos-9-small
