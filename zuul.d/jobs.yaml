---
- semaphore:
    name: sf-operator-publish-semaphore
    max: 1

- secret:
    name: zuul_quay_sf
    data:
      registry: "quay.io"
      username: "software-factory+zuul"
      password: !encrypted/pkcs1-oaep
        - QuMV8wy2oAOP6dgwmEqUtkcykFaA8taTXr8+XJ8NdNiErK9J89IhPVnYthX1geqnfuZdf
          IUvqo2LgB6cxw4cHEUXSZpfawyXT9WZOTv4s6bP0hI41eDpOVPFD/VG4QEf/oif/66ejf
          K6wK+YfD6o5l06nltj9qZR7H9atdYCHrANteeQqv9hWqCmeA9kSguPtuc7tWYkzINkvY2
          B/Nulc3D/bkAlmysiuhVX5eReJFJpX9L/jcNvPRcZehNLcVSRxSGTwz8OGO+xCNv7i0g0
          SlIn0DiPDh2duzzs1JgHiK5d2HpbgpuhsvyyWTvvgICu5eYdAOikqHS/WaF4zVvCJIUq8
          8VMWh+SD7DSpu9Zq2lyqMhuYwbvnl0TI0R1dYhBZV//vRqf8p2D46EIfVH/if8yn6sOq1
          rNjQ8IVEGp3QKBV1UYjhAoHgj/8gHd6NU/eh0g00LxTtnYjwfjVNIpV40ykdyJNtltELT
          QWVBfElXNFW8TDpd4zq43dA3VBgNjdEt+1cZmfzuxC8t8bgjRIaXLwhbeYBx7eIMDLRnT
          RrPZHG3xuwyIq3bnqMcatGYufBUPH8j9OfzYQLLwM08V5YEq55H0OKAFW+CtpmkUhRTNt
          clLXYqlBNOkutj4lrZLZLo1KdoaOEdOx+6A9Q29Ym3O4yp+Wf2a7rWJSdRNbtM=

# Base CI job
- job:
    name: base-sf-operator
    parent: base-microshift
    timeout: 2200
    post-run: playbooks/post.yaml
    run: playbooks/run.yaml
    nodeset:
      nodes:
        name: controller
        label: cloud-centos-9-stream
    required-projects:
      - name: software-factory/sf-infra
    roles:
      - zuul: software-factory/sf-infra
    vars:
      logclassify_logserver_dir: ./
      logclassify_debug: false
      logclassify_report: true
      # microshift deployment
      disk_file_sparsed: true
      disk_file_size: 40G
      standard_user: false
      create_pv: false
      setup_olm: true
      # post tasks artifacts directory
      output_logs_dir: ~/zuul-output/logs
      # dnsmasq
      microshift_additional_addresses:
        - "sftests.com"

# Images publication job
- job:
    name: sf-operator-publish-olm-bundle-image
    description: Publish operator's olm bundle image
    semaphore: sf-operator-publish-semaphore
    run: playbooks/publish.yaml
    timeout: 1200
    nodeset:
      nodes:
        name: controller
        label: cloud-centos-9-stream
    secrets:
      - name: final_registry_secret
        secret: zuul_quay_sf

# Deploy sf-operator on microshift
- job:
    name: sf-operator-functional-allinone-microshift
    description: This test validates a sf-operator deployment via OLM
    parent: base-sf-operator
    vars:
      mode: "ci"

- job:
    name: sf-operator-run-dev
    description: >
      This test validates a sf-operator deployment via the dev mode described
      in the contributor doc
    parent: base-sf-operator
    vars:
      mode: "dev"
