---
- include_role:
    name: zuul-lookup-conf
  vars:
    zuul_name: "{{ sf_name }}"

- include_role:
    name: "{{ item }}"
  loop:
    - zuul-ensure-gearman-tls
    - zuul-ensure-executor-ssh-key

- name: Convert spec to template input
  json_to_dhall:
    schema: "({{ sf_app_path }}).Input.Type"
    json: "{{ json_spec | to_json }}"
  vars:
    json_spec:
      name: "{{ sf_name }}"
      components: "{{ raw_spec['components'] | default({}) }}"
      connections: "{{ raw_spec['connections'] | default({}) }}"
      tenant: "{{ raw_spec['tenant'] | default({}) }}"
  register: _dhall

- include_role:
    name: dhall
  vars:
    expression: |
      {{ kubernetes_deploy_path }}
      (({{ sf_app_path }}).Application {{ _dhall.result }})

- include_role:
    name: zuul-restart-when-zuul-conf-changed
  vars:
    zuul_name: "{{ sf_name }}"
  when: zuul_conf_secret.data is defined

- include_role:
    name: zuul-reconfigure-tenant-when-conf-changed
  vars:
    zuul_name: "{{ sf_name }}"
  when: zuul_tenants_secret.data is defined
