- name: Install packages
  package:
    name:
      - golang
      - make
  become: true

# NOTE: This configuration is needed by Opensearch service
# https://opensearch.org/docs/opensearch/install/important-settings/
- name: Set important settings for Opensearch container
  become: true
  sysctl:
    name: vm.max_map_count
    value: "262144"
    state: present
    reload: true

- name: Configure default namespace
  command: kubectl config set-context --current --namespace=default

- name: Build the operator
  command: make build
  args:
    chdir: "{{ zuul.project.src_dir }}"

- name: Ensure the project is clean
  shell: |
    if [ ! -z "$(git status --porcelain)" ]; then
      git status
      echo "Add the above files modified by 'make build' to your commit and re-submit"
      exit 1
    fi
  args:
    chdir: "{{ zuul.project.src_dir }}"

- name: Install the CRDS
  command: make install
  args:
    chdir: "{{ zuul.project.src_dir }}"
