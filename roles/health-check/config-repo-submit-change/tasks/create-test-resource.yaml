---
- name: Create a resources file
  copy:
    content: |
      resources:
        projects:
          {{ repository_name }}:
            tenant: internal
            description: The best cloud platform engine
            source-repositories:
              - {{ repository_name }}:
                  connection: gerrit
                  zuul/config-project: True
        repos:
          {{ repository_name }}:
            description: The config project of ichiban-cloud
            acl: config-acl
    dest: "{{ config_path }}/{{ config_file_path }}"

- name: Commit file in the config repo
  command: "{{ item }}"
  args:
    chdir: "{{ config_path }}"
  loop:
    - "git add {{ config_file_path }}"
    - "git commit -m 'Add {{ config_file_path }}'"

- name: Submit change
  command: git review
  args:
    chdir: "{{ config_path}}"

- name: Get Change-id
  shell: git log -n 1 | awk '/Change-Id/ {print $2}'
  args:
    chdir: "{{ config_path }}"
  register: _change_id

# documentation: https://gerrit-review.googlesource.com/Documentation/rest-api-changes.html#set-review
- name: Set Code-Review and Workflow label using gerrit API
  uri:
    url: "https://{{ gerrit_host}}/a/changes/{{ _change_id.stdout }}/revisions/current/review"
    user: admin
    password: "{{ gerrit_admin_api_key }}"
    body_format: json
    body: >-
      {"labels": {
        "Code-Review": +2,
        "Workflow": +1
        }
      }
    validate_certs: "{{ validate_certs }}"
    method: POST
